session-start() {
    dir=$(worktree-create --no-cd) && project_name=$(basename "$dir" | sed "s/-worktree-[0-9]*$//") && session_name="$project_name-$(basename "$dir" | grep -o "worktree-[0-9]*")" && autocil --no-attach --name "$session_name" "$dir" && sleep 2 && tmux switch-client -t "$session_name"
}

session-finish() {
    # Parse flags
    local keep_session=false
    if [[ "$1" == "--keep" ]]; then
        keep_session=true
        shift
    fi
    
    # Save current tmux session name
    local current_session=$(tmux display-message -p '#S')
    
    # Check if we're in a worktree before doing anything
    local in_worktree=false
    if [[ "$PWD" == */worktrees/*-worktree-* ]]; then
        in_worktree=true
    fi
    
    # Track status of operations
    local commit_status="❌"
    local merge_status="❌"
    
    if commit-creator; then
        commit_status="✅"
        if worktree-merge; then
            merge_status="✅"
            
            # Only switch and kill session if we were in a worktree and not keeping session
            if [ "$in_worktree" = true ]; then
                # Extract project and worktree info from session name
                local project_name=$(echo "$current_session" | sed 's/-worktree-[0-9]*$//')
                local worktree_name=$(echo "$current_session" | grep -o 'worktree-[0-9]*')
                
                if [ "$keep_session" = true ]; then
                    # Send notification that session was kept
                    notify-send -u critical "Session Kept" "Project: $project_name\nWorktree: $worktree_name\nCommit: $commit_status Merge: $merge_status"
                else
                    # Check if we're still in the original worktree session
                    local current_active_session=$(tmux display-message -p '#S')
                    
                    if [ "$current_active_session" = "$current_session" ]; then
                        # We're still in the worktree session, need to switch before killing
                        local target_session=$(tmux list-sessions -F '#{session_name}' | grep -v "^${current_session}$" | head -1)
                        
                        if [ -n "$target_session" ]; then
                            # Send notification before switching sessions
                            notify-send -u critical "Session Closed" "Project: $project_name\nWorktree: $worktree_name\nCommit: $commit_status Merge: $merge_status"
                            # Switch to the other session first
                            tmux switch-client -t "$target_session"
                            # Then kill the worktree session
                            tmux kill-session -t "$current_session"
                        else
                            echo "Error: No other tmux session to switch to"
                            return 1
                        fi
                    else
                        # We've already switched to a different session, just kill the worktree session
                        notify-send -u critical "Session Closed" "Project: $project_name\nWorktree: $worktree_name\nCommit: $commit_status Merge: $merge_status"
                        tmux kill-session -t "$current_session"
                    fi
                fi
            fi
        else
            # Merge failed - keep session open
            if [ "$in_worktree" = true ]; then
                local project_name=$(echo "$current_session" | sed 's/-worktree-[0-9]*$//')
                local worktree_name=$(echo "$current_session" | grep -o 'worktree-[0-9]*')
                notify-send -u critical "Merge Failed - Session Kept" "Project: $project_name\nWorktree: $worktree_name\nCommit: $commit_status Merge: $merge_status\n\nResolve conflicts and try again"
            fi
            echo "Error: worktree-merge failed - session kept open"
            return 1
        fi
    else
        echo "Error: commit creator failed"
        # Still send notification if in worktree
        if [ "$in_worktree" = true ]; then
            local project_name=$(echo "$current_session" | sed 's/-worktree-[0-9]*$//')
            local worktree_name=$(echo "$current_session" | grep -o 'worktree-[0-9]*')
            notify-send -u critical "Session Failed" "Project: $project_name\nWorktree: $worktree_name\nCommit: $commit_status Merge: $merge_status"
        fi
        return 1
    fi
}
