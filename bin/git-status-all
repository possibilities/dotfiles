#!/bin/bash

# Function to check git status
check_git_status() {
    local dir="$1"
    local project=$(basename "$dir")
    
    if [ -d "$dir/.git" ]; then
        cd "$dir"
        
        # Check for uncommitted changes
        if [ -n "$(git status --porcelain 2>/dev/null)" ]; then
            echo "$project|error"
            return
        fi
        
        # Check for unpushed commits
        local branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
        if [ -n "$branch" ] && [ "$branch" != "HEAD" ]; then
            local upstream=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null)
            if [ -n "$upstream" ]; then
                local ahead=$(git rev-list --count @{u}..HEAD 2>/dev/null)
                if [ "$ahead" -gt 0 ]; then
                    echo "$project|error"
                    return
                fi
            else
                echo "$project|error"
                return
            fi
        fi
        
        # All good
        echo "$project|ok"
    fi
}

# Collect all results first
results=()
for dir in ~/code/*/; do
    if [ -d "$dir" ]; then
        # Skip backups and worktrees directories
        basename_dir=$(basename "$dir")
        if [ "$basename_dir" != "backups" ] && [ "$basename_dir" != "worktrees" ]; then
            result=$(check_git_status "$dir")
            if [ -n "$result" ]; then
                results+=("$result")
            fi
        fi
    fi
done

# Find the longest repo name for proper column width
max_len=10  # Minimum width for "Repository" header
for result in "${results[@]}"; do
    repo_name="${result%%|*}"
    if [ ${#repo_name} -gt $max_len ]; then
        max_len=${#repo_name}
    fi
done

# Print header
printf "%-${max_len}s | %s\n" "Repository" "Status"
printf "%s-+-%s\n" "$(printf '%*s' $max_len | tr ' ' '-')" "------"

# Print results
for result in "${results[@]}"; do
    IFS='|' read -r repo state <<< "$result"
    if [ "$state" = "error" ]; then
        status="x"
    else
        status=""
    fi
    printf "%-${max_len}s | %-6s\n" "$repo" "$status"
done